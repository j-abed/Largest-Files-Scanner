Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# Enable modern styles
[System.Windows.Forms.Application]::EnableVisualStyles()

# ----------------- FORM SETUP -----------------
$form = New-Object System.Windows.Forms.Form
$form.Text = "Largest Files Scanner"
$form.Size = New-Object System.Drawing.Size(600, 260)
$form.StartPosition = "CenterScreen"
$form.MaximizeBox = $false

# Labels
$labelDrive = New-Object System.Windows.Forms.Label
$labelDrive.Text = "Drive / Folder:"
$labelDrive.Location = New-Object System.Drawing.Point(20, 20)
$labelDrive.AutoSize = $true

$labelMinSize = New-Object System.Windows.Forms.Label
$labelMinSize.Text = "Min size (MB):"
$labelMinSize.Location = New-Object System.Drawing.Point(20, 55)
$labelMinSize.AutoSize = $true

$labelMaxResults = New-Object System.Windows.Forms.Label
$labelMaxResults.Text = "Max results:"
$labelMaxResults.Location = New-Object System.Drawing.Point(20, 90)
$labelMaxResults.AutoSize = $true

# Inputs
$textDrive = New-Object System.Windows.Forms.TextBox
$textDrive.Location = New-Object System.Drawing.Point(130, 18)
$textDrive.Size = New-Object System.Drawing.Size(180, 22)
$textDrive.Text = "C:\"

$numericMinSize = New-Object System.Windows.Forms.NumericUpDown
$numericMinSize.Location = New-Object System.Drawing.Point(130, 53)
$numericMinSize.Minimum = 1
$numericMinSize.Maximum = 100000
$numericMinSize.Value = 50

$numericMaxResults = New-Object System.Windows.Forms.NumericUpDown
$numericMaxResults.Location = New-Object System.Drawing.Point(130, 88)
$numericMaxResults.Minimum = 1
$numericMaxResults.Maximum = 1000
$numericMaxResults.Value = 25

# Buttons
$buttonScan = New-Object System.Windows.Forms.Button
$buttonScan.Text = "Scan"
$buttonScan.Location = New-Object System.Drawing.Point(340, 18)
$buttonScan.Size = New-Object System.Drawing.Size(100, 30)

$buttonView = New-Object System.Windows.Forms.Button
$buttonView.Text = "View Results"
$buttonView.Location = New-Object System.Drawing.Point(340, 58)
$buttonView.Size = New-Object System.Drawing.Size(100, 30)
$buttonView.Enabled = $false

$buttonExport = New-Object System.Windows.Forms.Button
$buttonExport.Text = "Export CSV"
$buttonExport.Location = New-Object System.Drawing.Point(340, 98)
$buttonExport.Size = New-Object System.Drawing.Size(100, 30)
$buttonExport.Enabled = $false

$buttonClose = New-Object System.Windows.Forms.Button
$buttonClose.Text = "Close"
$buttonClose.Location = New-Object System.Drawing.Point(460, 18)
$buttonClose.Size = New-Object System.Drawing.Size(100, 30)

# Progress bar & status
$progressBar = New-Object System.Windows.Forms.ProgressBar
$progressBar.Location = New-Object System.Drawing.Point(20, 140)
$progressBar.Size = New-Object System.Drawing.Size(540, 25)
$progressBar.Minimum = 0
$progressBar.Maximum = 100
$progressBar.Value = 0

$labelStatus = New-Object System.Windows.Forms.Label
$labelStatus.Text = "Ready."
$labelStatus.Location = New-Object System.Drawing.Point(20, 175)
$labelStatus.Size = New-Object System.Drawing.Size(540, 30)

# Add controls to form
$form.Controls.AddRange(@(
    $labelDrive, $labelMinSize, $labelMaxResults,
    $textDrive, $numericMinSize, $numericMaxResults,
    $buttonScan, $buttonView, $buttonExport, $buttonClose,
    $progressBar, $labelStatus
))

# ----------------- EVENT HANDLERS -----------------

# Helper to pump UI messages
function Update-UI {
    [System.Windows.Forms.Application]::DoEvents()
}

$buttonScan.Add_Click({
    $buttonScan.Enabled   = $false
    $buttonView.Enabled   = $false
    $buttonExport.Enabled = $false
    $progressBar.Value    = 0
    $labelStatus.Text     = "Starting scan..."
    Update-UI

    $drivePath   = $textDrive.Text.Trim()
    $minSizeMB   = [int]$numericMinSize.Value
    $maxResults  = [int]$numericMaxResults.Value
    $minSizeBytes = $minSizeMB * 1MB

    if (-not (Test-Path $drivePath)) {
        [System.Windows.Forms.MessageBox]::Show(
            "Path not found: $drivePath",
            "Error",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Error
        ) | Out-Null
        $labelStatus.Text = "Invalid path."
        $buttonScan.Enabled = $true
        return
    }

    try {
        $labelStatus.Text = "Phase 1/3: Enumerating files..."
        $progressBar.Value = 10
        Update-UI

        $files = Get-ChildItem -Path $drivePath -File -Recurse -ErrorAction SilentlyContinue

        $labelStatus.Text = "Phase 2/3: Filtering files >= $minSizeMB MB..."
        $progressBar.Value = 50
        Update-UI

        $largeFiles = $files | Where-Object { $_.Length -ge $minSizeBytes }

        $labelStatus.Text = "Phase 3/3: Sorting & selecting top $maxResults..."
        $progressBar.Value = 80
        Update-UI

        $Global:LargestFilesResults = $largeFiles |
            Sort-Object Length -Descending |
            Select-Object -First $maxResults `
                @{Name="FullName"; Expression = { $_.FullName }},
                @{Name="SizeGB";   Expression = { [math]::Round($_.Length / 1GB, 2) }},
                @{Name="SizeMB";   Expression = { [math]::Round($_.Length / 1MB, 1) }}

        $count = $Global:LargestFilesResults.Count
        $progressBar.Value = 100
        $labelStatus.Text = "Done. Found $count file(s) meeting the criteria."
        $buttonView.Enabled   = $count -gt 0
        $buttonExport.Enabled = $count -gt 0
    }
    catch {
        [System.Windows.Forms.MessageBox]::Show(
            "An error occurred:`n$($_.Exception.Message)",
            "Error",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Error
        ) | Out-Null
        $labelStatus.Text = "Error during scan."
    }
    finally {
        $buttonScan.Enabled = $true
        Update-UI
    }
})

$buttonView.Add_Click({
    if ($Global:LargestFilesResults -and $Global:LargestFilesResults.Count -gt 0) {
        $Global:LargestFilesResults | Out-GridView -Title "Largest Files"
    }
    else {
        [System.Windows.Forms.MessageBox]::Show(
            "No results to display.",
            "Info",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Information
        ) | Out-Null
    }
})

$buttonExport.Add_Click({
    if (-not ($Global:LargestFilesResults) -or $Global:LargestFilesResults.Count -eq 0) {
        [System.Windows.Forms.MessageBox]::Show(
            "No results to export.",
            "Info",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Information
        ) | Out-Null
        return
    }

    $dialog = New-Object System.Windows.Forms.SaveFileDialog
    $dialog.Filter = "CSV files (*.csv)|*.csv|All files (*.*)|*.*"
    $dialog.FileName = "LargestFiles.csv"

    if ($dialog.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
        $Global:LargestFilesResults |
            Export-Csv -Path $dialog.FileName -NoTypeInformation -Encoding UTF8

        [System.Windows.Forms.MessageBox]::Show(
            "Export complete:`n$($dialog.FileName)",
            "Export CSV",
            [System.Windows.Forms.MessageBoxButtons]::OK,
            [System.Windows.Forms.MessageBoxIcon]::Information
        ) | Out-Null

        $labelStatus.Text = "CSV exported to: $($dialog.FileName)"
    }
})

$buttonClose.Add_Click({
    $form.Close()
})

# ----------------- RUN FORM -----------------
[System.Windows.Forms.Application]::Run($form)
